<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <meta name="color-scheme" content="light dark" />
    <style>
        body.dark {
            --text: dark;
            --background: white;
        }

        body.dark {
            --text: white;
            --background: black;
        }

        body {
            color: var(--text);
            background: var(--background);
        }
    </style>
</head>

<body class="light">
    <button id="theme-toggle">click</button>
    <div>
        test
    </div>
    <script>
        function getUserPreference() {
            return localStorage.getItem('theme') || 'system';
        }

        function saveUserPreference(userPreference) {
            localStorage.setItem('theme', userPreference);
        }

        function getAppliedMode(userPreference) {
            if (userPreference === 'light') {
                return 'light';
            }
            if (userPreference === 'dark') {
                return 'dark';
            }
            // system
            if (matchMedia('(prefers-color-scheme: light)').matches) {
                return 'light';
            }
            return 'dark';
        }

        const colorScheme = document.querySelector('meta[name="color-scheme"]');

        function setAppliedMode(mode) {
            document.body.className = mode;
            colorScheme.content = mode;
        }

        function rotatePreferences(userPreference) {
            if (userPreference === 'system') {
                return 'light'
            }
            if (userPreference === 'light') {
                return 'dark';
            }
            if (userPreference === 'dark') {
                return 'system';
            }
            // for invalid values, just in case
            return 'system';
        }

        const themeDisplay = document.getElementById('mode');
        const themeToggler = document.getElementById('theme-toggle');

        let userPreference = getUserPreference();
        setAppliedMode(getAppliedMode(userPreference));
        themeDisplay.innerText = userPreference;

        themeToggler.onclick = () => {
            const newUserPref = rotatePreferences(userPreference);
            userPreference = newUserPref;
            saveUserPreference(newUserPref);
            themeDisplay.innerText = newUserPref;
            setAppliedMode(getAppliedMode(newUserPref));
        }
    </script>
</body>

</html>